# Докер образы

У bareos нет официальных docker-образов, поэтому они собираются самостоятельно.

Файлы для сборки образа находятся в **./services/bareos/docker**

В Dockerfile описаны несколько образов (multistage build):

- bareos director (dir)
- bareos storage daemon (sd)
- bareos file daemon (fd)
- bareos webui

Собрать образы и запушить их на dockerhub можно скриптом **build.sh**.
Версия образов указывается в скрипте **build.sh**

Примеры запуска всех образов есть в **docker-compose**.


# Описание образов

Во все образы добавляются репозитории bareos, копируется скрипт **make_bareos_config.sh** и
entrypoint. У каждого образа свой файл entrypoint.

Все entrypoint-ы запускают скрипт **make_bareos_config.sh**.
Webui, кроме скрипта, запускает **php-fpm**.

Cmd у всех образов кроме webui - соответствующий демон bareos (bareos-dir, bareos-sd, bareos-fd).
У webui cmd - nginx.

Dir, кроме скрипта, может запускать создание или обновление таблиц базы данных bareos.

Для создания таблиц нужно установить переменную окружения ``DB_INIT=1``. Для обновления -
``DB_UPDATE=1``. Кроме того, в обоих случаях должны быть установлены переменные
``BAREOS__DB_HOST`` (адрес postgres), ``POSTGRES_ADMIN_USER`` (пользователь админ postgres) и
``POSTGRES_ADMIN_PASSWORD`` (пароль админа postgres).

Создание таблиц нужно при первом запуске bareos, потому что bareos не умеет делать это
самостоятельно. Обновление - при обновлении bareos.

## make_bareos_config.sh

Все пароли bareos хранит в файлах конфигурации.

Скрипт **make_bareos_config.sh** нужен, чтобы задавать пароли и другие настройки через переменные
окружения.

Он удаляет содержимое папки **/etc/bareos** и копирует в нее содержимое **/etc_bareos**.

После этого все переменные окружения, начинающиеся с ``BAREOS__`` подставляются во все файлы
в **/etc/bareos** (обходится рекурсивно).

В файлах переменные должны быть обрамлены двойными фигурными скобками.

Переменные окружения задаются динамически (т. е. не определены при сборке образа), потому что
их количество может быть произвольным. Например, для каждого нового клиента в файлах конфигурации
требуется новый пароль.

Пример:

Есть файл

```nginx
Catalog {
  Name = BareosCatalog
  DB Address = "{{BAREOS__DB_HOST}}"

  # ...
}
```

Если запустить образ с переменной окружения ``BAREOS__DB_HOST=bareos-db-host``, то
содержимое файла станет:

```nginx
Catalog {
  Name = BareosCatalog
  DB Address = "bareos-db-host"

  # ...
}
```


