version: '3'

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    hostname: traefik.home.localhost
    restart: unless-stopped
    command:
      - "--providers.docker"
      # Enables the web UI
      - "--api.insecure=true"
      - "--entrypoints.http.address=:80"
      # - "--entrypoints.https.address=:443"
      - "--entrypoints.ssh.address=:22"
      # - "--log.level=DEBUG"
      - "--log=true"
      - "--log.filePath=/logs/traefik.log"
    ports:
      - "80:80"
      # The Web UI (enabled by --api.insecure=true)
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  gitea:
    image: gitea/gitea:1.21.4
    container_name: gitea
    hostname: git.home.localhost
    restart: unless-stopped
    environment:
        - TZ="Asia/Yekaterinburg"
        - LANG=ru_RU.UTF-8
        - LANGUAGE=ru_RU.UTF-8
        - LC_ALL=ru_RU.UTF-8
    volumes:
      - ${PWD}/services/gitea/data:/data
      - /home/git/.ssh:/data/git/.ssh
    ports:
      - "2222:22"
    labels:
      # http
      - "traefik.http.routers.git-web.rule=Host(`git.home.localhost`)"
      - "traefik.http.routers.git-web.entrypoints=http"
      - "traefik.http.routers.git-web.service=gitea-web"
      - "traefik.http.services.gitea-web.loadbalancer.server.port=3000"
      # ssh
      - "traefik.tcp.routers.git-ssh.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.git-ssh.entrypoints=ssh"
      - "traefik.tcp.routers.git-ssh.service=gitea-ssh"
      - "traefik.tcp.services.gitea-ssh.loadbalancer.server.port=22"



   # labels:
      # - "traefik.http.routers.git.middlewares=auth"
      # - "traefik.http.middlewares.auth.basicauth.users=test:$$2y$$12$$ci.4U63YX83CwkyUrjqxAucnmi2xXOIlEF6T/KdP9824f1Rf1iyNG" # test:test
      # - "traefik.http.services.git.loadBalancer.server.port=9000"

