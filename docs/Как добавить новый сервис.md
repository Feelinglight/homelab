# Как добавить новый сервис

Правила добавления сервисов:

- В compose-файлов не должно быть абсолютных путей. Если такие пути требуются, они должны
  добавляться с помощью переменных окружения в **.env**

Порядок добавления сервиса:

1. Добавить сервис в docker-compose
3. Добавить в .env секцию с новым сервисом, объявить там переменную с доменным именем
4. Добавить в docker-compose, в контейнеры **traefik** и **authelia** проброс добавленной
   переменной
5. Добавить проксирование к сервису в traefik с использованием добавленной переменной
6. Тестирование доступа к сервису лучше выполнять из режима инкогнито, chrome может что-нибудь
   закэшировать.

   Перед тестированием доступа сбросить DNS-кэш у systemd-resolve:

   ```bash
   sudo resolvectl flush-caches
   ```

7. Добавить сервис в **services/authelia/config/configuration.yml**, в раздел
   **access_control** -> **rules**.

   - Если у сервиса нет авторизации, то установить **policy** = **one_factor**.
   - Если у сервиса есть своя авторизация, то установить **policy** = **bypass**.
   - Если у сервиса есть возможность авторизации через внешнего провайдера OAuth2, то
     дополнительно настроить авторизацию через authelia.

8. Добавить сервис на главную страницу homer. Содержимое главной страницы определяется в
   **services/homer/assets/config.yml**.

9. Замиррорить все ненадеждные зависимости сервиса (гитхаб репозитории, докер репозитории,
   deb пакеты и т. д.)

   Дописать скрипт **./services/scripts/mirror_dependencies.sh** для автоматического
   мирроринга (сам скрипт автоматически не запускается, только вручную).

10. Добавить все файлы и папки нового сервиса в бэкап (если они находятся не в папке репозитория)

11. Добавить бэкап баз данных в скрипт **./scripts/backup_all.sh**. Скрипт бэкапа запускается
    бареосом перед запуском резервного копирования.

111. Если необходимо:

     - Обновить README.md
     - Добавить документацию на сервис в **docs**
     - Обновить документацию в **docs/Как развернуть сервер.md**
     - Обновить **tamplate.env**

# Как добавить нового пользователя в authelia

Пользователи добавляются через файл **services/authelia/config/users_database.yml**.
Нужно ввести логин, почту и хэш пароля.

Хэш пароля можно получить следующими способами:

- Командой в интерактивном режиме:

  ```bash
  docker exec -it authelia authelia crypto hash generate --config /config/configuration.yaml
  ```

- Командой в неинтерактивном режиме:

  ```bash
  docker exec authelia authelia crypto hash generate --config /config/configuration.yaml --password "password"
  ```

  Лучше начинать такую команду с пробела, чтобы она не осталась в истории

# Как добавить нового пользователя и БД

Добавление новых пользователей и БД для **postgres** и **mariadb** описано в скриптах
**scripts/make_pg_user.sh** и **scripts/make_mariadb_user.sh**

