# remove_expired_volumes

Срипты для автоматического удаления job и томов (включая данные томов) в скользящем окне.

Перед выполнением полного бэкапа, скрипт ищет все цепочки "Полный-инкрементальные" и удаляет
все цепочки, предшествующие последней успешной.

Успешной цепочкой считается та, в которой успешно выполнен полный бэкап.

Максимальное количество успешных цепочек бэкапов в произвольный момент времени будет 2. Минимальное - 1.

В нормальном режиме работы количество бэкапов почти всегда 2. Одна цепочка может остаться в случае,
когда полный бэкап завалился, т. к. удаление лишних цепочек работает **перед** выполнением полного бэкапа.

Также удаляет файлы томов всех неудачных бэкапов. В БД bareos все неудачные бэкапы и их тома
оставляются. Бэкапы оставляются на всякий случай (например, чтобы иметь возможность смотреть их
логи). Тома оставляются потому, что если удалить хотя бы один том бэкапа, то bareos удалит
вместе с ним сам бэкап.

Полные логи скриптов **remove_expired_volumes** пишутся в папку пула job-ы. Файлы с логами пока
что не удаляются в скользящем окне и постоянно копятся.

В логи job-ы также пишутся логи, но не такие полные.


## Использование

Скрипт должен вызываться в Job.RunBefore на стороне директора bareos. Если скрипт завершается
с ошибкой, то бэкап должен быть отменен.

Для правильного удаления bootstrap файлов они должны сохранятся в папку с томами Job-ы с
правильным именем (см. пример).

Пример добавления скрипта в bareos Job:

```nginx
Job {
  Name = DockerLinuxJob

  # ...

  # 0 в имени для красивой сортировки с файлами томов, там в этом месте количество томов
  # С таким шаблоном bsr-файл текущей job-ы будет всегда находиться
  # - после всех томов предыдущей job-ы
  # - перед всеми томами текущей job-ы
  Write Bootstrap = "/backups/DockerLinux/%j-%i-0-%l.bsr"

  RunScript {
    RunsWhen = Before
    FailJobOnError = Yes
    Runs On Client = No
    Command = "bash -c 'cd /usr/local/bin/remove_expired_volumes && "
              "PYTHONPATH=PYTHONPATH:${PWD} python3 -m src -j %n -i %i -l %l -s %w -p %p'"
  }
}
```
